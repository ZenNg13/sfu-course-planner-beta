# SFU Course Tracker - Architecture Documentation

## Overview
This is a full-stack course scheduling application that fetches **real-time data** from SFU automatically.

## Technology Stack

### Frontend
- **Framework**: React 18 + TypeScript
- **Build Tool**: Vite 5.4.21
- **Styling**: Tailwind CSS (dark mode, SFU red theme)
- **State Management**: Zustand
- **Calendar**: react-big-calendar
- **Icons**: lucide-react
- **Port**: 3000

### Backend
- **Framework**: FastAPI 0.109.0 (Python 3.12)
- **Database**: **SQLite** (NOT PostgreSQL)
- **ORM**: SQLModel 0.0.14
- **HTTP Client**: httpx 0.26.0
- **HTML Parser**: BeautifulSoup4 4.12.2
- **Graph Library**: NetworkX 3.2.1 (for prerequisites)
- **Scheduler**: APScheduler 3.10.4
- **Port**: 8000

## Data Flow Architecture

### ✅ Fully Automatic Data Fetching

```
SFU API (www.sfu.ca)            CourSys (coursys.sfu.ca)
        |                                |
        v                                v
  [Python Crawler] -----------------> [Backend API]
        |                                |
        v                                v
  JSON Cache File                  Live Enrollment
        |                                |
        |                                |
        +-------------> [Frontend] <-----+
                            |
                            v
                      [User Interface]
```

### Data Sources

1. **Course Information** (from SFU API)
   - URL: `www.sfu.ca/bin/wcm/course-outlines`
   - Data: Course titles, descriptions, schedules, instructors, prerequisites
   - Method: REST API (JSON responses)
   - Cached: Yes (in `fall_2025_courses_with_enrollment.json`)

2. **Live Enrollment** (from CourSys)
   - URL: `coursys.sfu.ca/browse/info`
   - Data: Real-time enrollment numbers, waitlist counts
   - Method: HTML scraping (BeautifulSoup4)
   - Cached: No (fetched on-demand)
   - Auto-refresh: Every 5 minutes (frontend)

## File Structure

### Data Files (AFTER CLEANUP)

```
backend/data/
  └── fall_2025_courses_with_enrollment.json  (1.3MB - 251 CMPT sections)
      ✓ This is the ONLY data file
      ✓ Contains course info + initial enrollment snapshot
      ✓ Generated by crawler (backend/crawler/sfu_api_client.py)
```

**Removed Files** (no longer needed):
- ❌ `data/fall_2025_courses.json` (duplicate)
- ❌ `backend/data/fall_2025_courses.json` (old version without enrollment)
- ❌ `frontend/src/data/mockData.ts` (static mock data)

### Database (SQLite)

```
backend/sfu_scheduler.db
  ├── courses (84 rows)
  ├── sections (6 rows) 
  └── watchers (user alerts)
```

**Note**: The database is currently underpopulated. The system primarily uses:
1. JSON file for course search
2. Live API calls for enrollment data

This works well because:
- Course catalog doesn't change often → JSON cache is fine
- Enrollment changes constantly → Must fetch live from CourSys

## API Endpoints

### Backend (FastAPI)

#### Course Data
```
GET  /api/v1/courses/all
     → Returns all 251 courses from JSON file
     
GET  /api/v1/courses/search?q=CMPT
     → Search courses by keyword
     
GET  /api/v1/courses/{dept}/{number}
     → Get specific course details
     
GET  /api/v1/courses/{dept}/{number}/sections
     → Get all sections for a course
```

#### Live Enrollment (Real-time from CourSys)
```
GET  /api/v1/courses/enrollment/{dept}/{number}/{section}?term=2025/fall
     → Fetch live enrollment for ONE section
     Example: GET /enrollment/CMPT/354/D100
     Response: {
       "dept": "CMPT",
       "number": "354",
       "section": "D100",
       "enrolled": "150/150",
       "waitlist": "15",
       "timestamp": "2025-11-25T10:30:00"
     }

POST /api/v1/courses/enrollment/batch?term=2025/fall
     Body: [
       {"dept": "CMPT", "number": "354", "section": "D100"},
       {"dept": "CMPT", "number": "120", "section": "D100"}
     ]
     → Fetch live enrollment for MULTIPLE sections at once (efficient)
```

## Frontend Components

### Key Components
1. **ControlBar** (`src/components/Layout/ControlBar.tsx`)
   - Fetches all courses from `/api/v1/courses/all` on mount
   - Provides course search and filtering
   - **No longer uses mockData.ts** ✅

2. **CourseCard** (`src/components/CourseList/CourseCard.tsx`)
   - Displays course information
   - Uses `useSingleEnrollment()` hook for live data
   - Shows real-time enrollment: "150/150 (15W)"

3. **SectionSelectorModal** (`src/components/CourseList/SectionSelectorModal.tsx`)
   - Lets users choose which section to schedule
   - Uses batch API for efficient enrollment fetching

### React Hooks

**useEnrollmentData.ts**
```typescript
useSingleEnrollment(dept, number, section)
  → Fetches live enrollment for one course
  → Auto-refreshes every 5 minutes
  → Returns: { enrolled, waitlist, loading, error }

useEnrollmentData(courses[])
  → Fetches live enrollment for multiple courses
  → Uses batch API endpoint
  → Auto-refreshes every 5 minutes
```

## How to Run

### Start Backend
```bash
cd backend
source venv/bin/activate  # Linux/Mac
python3 main.py
```
Backend runs on `http://localhost:8000`

### Start Frontend
```bash
cd frontend
npm run dev
```
Frontend runs on `http://localhost:3000`

## How to Update Course Data

### Fetch Latest Courses from SFU
```bash
cd backend
source venv/bin/activate
python3 -m crawler.test_crawler
```

This will:
1. Fetch all CMPT courses from SFU API
2. Scrape live enrollment from CourSys
3. Save to `backend/data/fall_2025_courses_with_enrollment.json`
4. Frontend automatically loads new data on next refresh

## External Links

All links use **real data**:

1. **CourSys** - `https://coursys.sfu.ca/2025fa-{dept}-{number}-{section}/`
   - Example: `https://coursys.sfu.ca/2025fa-cmpt-354-d100/`
   
2. **Rate My Professor** - Search by instructor name
   - Example: `https://www.ratemyprofessors.com/search/professors?q=John+Smith`

3. **SFU Bookstore** - Textbook lookup
   - Example: `https://shop.sfu.ca/course-materials/my-personalized-course-materials`

4. **CourseDiggers** - Past grade distributions
   - Example: `https://coursediggers.com/courses/CMPT354`

## Key Features

✅ **Automatic Data Fetching** - No manual updates needed
✅ **Real-time Enrollment** - Live data from CourSys (5-min auto-refresh)
✅ **Drag-and-Drop Scheduling** - Add courses to calendar
✅ **Section Selection** - Choose specific lecture/lab times
✅ **Prerequisite Tracking** - Shows required courses
✅ **External Resources** - Direct links to CourSys, RMP, textbooks
✅ **Dark Mode** - SFU-branded dark theme (#A6192E red)

## Important Notes

1. **Database Type**: This project uses **SQLite**, not PostgreSQL
   - File: `backend/sfu_scheduler.db`
   - No need to install PostgreSQL server

2. **No Static Mock Data**: The frontend now fetches everything from the backend API
   - Removed: `mockData.ts`
   - All data is either from JSON cache or live CourSys

3. **Enrollment is ALWAYS Live**: 
   - CourseCard shows live enrollment (auto-refreshes every 5 min)
   - Section selector shows live enrollment for all sections
   - JSON file only provides initial snapshot

4. **Crawler Rate Limiting**:
   - 0.2s delay between CourSys requests (5 requests/second)
   - Respectful of SFU servers
   - Can adjust in `sfu_api_client.py`

## Future Improvements

1. **Database Population**: Load all 251 sections into SQLite for better querying
2. **Multi-Department Support**: Currently only CMPT, could add MATH, ENSC, etc.
3. **Background Updates**: Use APScheduler to auto-refresh JSON nightly
4. **User Accounts**: Save schedules, get enrollment alerts
5. **Conflict Detection**: Warn about overlapping class times

## Troubleshooting

### Frontend shows "No courses found"
- Check backend is running on port 8000
- Verify `/api/v1/courses/all` returns 251 courses
- Check browser console for CORS errors

### Enrollment shows "N/A"
- CourSys might be down or blocking requests
- Check backend logs for HTTP errors
- Verify term format is correct (e.g., "2025/fall")

### Crawler fails
- SFU API might have changed format
- Check `backend/crawler/sfu_api_client.py` for updated URLs
- Verify BeautifulSoup selectors still match HTML

---

**Last Updated**: 2025-11-25
**Version**: 1.0.0
